"use strict";define("admin/manage/category",["uploader","iconSelect","admin/modules/colorpicker","autocomplete","translator"],function(e,a,t,i,r){var n={};var o={};n.init=function(){$("#category-settings select").each(function(){var e=$(this);e.val(e.attr("data-value"))});$("#category-selector").on("change",function(){ajaxify.go("admin/manage/categories/"+$(this).val())});function i(e,a){var i=$(a);var r=i.parents("[data-cid]").find(".category-preview");t.enable(i,function(e,a){if(i.attr("data-name")==="bgColor"){r.css("background-color","#"+a)}else if(i.attr("data-name")==="color"){r.css("color","#"+a)}c(i[0])})}$("#category-settings input, #category-settings select").not($(".privilege-table-container input")).on("change",function(e){c(e.target)}).on("keydown",function(e){if(e.which===13){e.preventDefault();return false}});$('[data-name="imageClass"]').on("change",function(){$(".category-preview").css("background-size",$(this).val())});$('[data-name="bgColor"], [data-name="color"]').each(i);$("#save").on("click",function(){if(Object.keys(o).length){socket.emit("admin.categories.update",o,function(e,a){if(e){return app.alertError(e.message)}if(a&&a.length){app.flags._unsaved=false;app.alert({title:"Updated Categories",message:"Category IDs "+a.join(", ")+" was successfully updated.",type:"success",timeout:2e3})}});o={}}return false});$(".purge").on("click",function(e){e.preventDefault();bootbox.confirm(r.compile("admin/manage/categories:alert.confirm-purge",$("form.category").find('input[data-name="name"]').val()),function(e){if(!e){return}socket.emit("admin.categories.purge",ajaxify.data.category.cid,function(e){if(e){return app.alertError(e.message)}app.alertSuccess("[[admin/manage/categories:alert.purge-success]]");ajaxify.go("admin/manage/categories")})})});$(".copy-settings").on("click",function(){l(function(e){socket.emit("admin.categories.copySettingsFrom",{fromCid:e,toCid:ajaxify.data.category.cid},function(e){if(e){return app.alertError(e.message)}app.alertSuccess("[[admin/manage/categories:alert.copy-success]]");ajaxify.refresh()})});return false});$(".upload-button").on("click",function(){var a=$(this);var t=a.attr("data-cid");e.show({title:"[[admin/manage/categories:alert.upload-image]]",route:config.relative_path+"/api/admin/category/uploadpicture",params:{cid:t}},function(e){$("#category-image").val(e);var t=a.parent().parent().siblings(".category-preview");t.css("background","url("+e+"?"+(new Date).getTime()+")");c($("#category-image"))})});$("#category-image").on("change",function(){$(".category-preview").css("background-image",$(this).val()?'url("'+$(this).val()+'")':"")});$(".delete-image").on("click",function(e){e.preventDefault();var a=$("#category-image");var t=$(".category-preview");a.val("");t.css("background-image","");c(a[0]);$(this).parent().addClass("hide").hide()});$(".category-preview").on("click",function(){a.init($(this).find("i"),c)});$('button[data-action="setParent"], button[data-action="changeParent"]').on("click",n.launchParentSelector);$('button[data-action="removeParent"]').on("click",function(){var e={};e[ajaxify.data.category.cid]={parentCid:0};socket.emit("admin.categories.update",e,function(e){if(e){return app.alertError(e.message)}$('button[data-action="removeParent"]').parent().addClass("hide");$('button[data-action="changeParent"]').parent().addClass("hide");$('button[data-action="setParent"]').removeClass("hide")})});n.setupPrivilegeTable();s()};function c(e){var a=ajaxify.data.category.cid;if(a){o[a]=o[a]||{};o[a][$(e).attr("data-name")]=$(e).val();app.flags=app.flags||{};app.flags._unsaved=true}}function s(){var e=$("#tag-whitelist");e.tagsinput({confirmKeys:[13,44],trimValue:true});ajaxify.data.category.tagWhitelist.forEach(function(a){e.tagsinput("add",a)});e.on("itemAdded itemRemoved",function(){c(e)})}n.setupPrivilegeTable=function(){$(".privilege-table-container").on("change",'input[type="checkbox"]',function(){var e=$(this);var a=e.parent().attr("data-privilege");var t=e.prop("checked");var i=e.parents("tr");var r=i.attr("data-group-name")||i.attr("data-uid");var o=parseInt(i.attr("data-private")||0,10);var c=i.attr("data-group-name")!==undefined;if(r){if(c&&a==="groups:moderate"&&!o&&t){bootbox.confirm("[[admin/manage/categories:alert.confirm-moderate]]",function(i){if(i){n.setPrivilege(r,a,t,e)}else{e.prop("checked",!e.prop("checked"))}})}else{n.setPrivilege(r,a,t,e)}}else{app.alertError("[[error:invalid-data]]")}});$(".privilege-table-container").on("click",'[data-action="search.user"]',n.addUserToPrivilegeTable);$(".privilege-table-container").on("click",'[data-action="search.group"]',n.addGroupToPrivilegeTable);$(".privilege-table-container").on("click",'[data-action="copyToChildren"]',n.copyPrivilegesToChildren);$(".privilege-table-container").on("click",'[data-action="copyPrivilegesFrom"]',n.copyPrivilegesFromCategory);n.exposeAssumedPrivileges()};n.refreshPrivilegeTable=function(){socket.emit("admin.categories.getPrivilegeSettings",ajaxify.data.category.cid,function(e,a){if(e){return app.alertError(e.message)}templates.parse("admin/partials/categories/privileges",{privileges:a},function(e){r.translate(e,function(e){$(".privilege-table-container").html(e);n.exposeAssumedPrivileges()})})})};n.exposeAssumedPrivileges=function(){var e=[];$('.privilege-table tr[data-group-name="registered-users"] td input[type="checkbox"]').parent().each(function(a,t){if($(t).find("input").prop("checked")){e.push(t.getAttribute("data-privilege"))}});for(var a=0,t=e.length;a<t;a+=1){var i=$('.privilege-table tr[data-group-name]:not([data-group-name="registered-users"],[data-group-name="guests"]) td[data-privilege="'+e[a]+'"] input');i.each(function(e,a){if(!a.checked){a.indeterminate=true}})}};n.setPrivilege=function(e,a,t,i){socket.emit("admin.categories.setPrivilege",{cid:ajaxify.data.category.cid,privilege:a,set:t,member:e},function(e){if(e){return app.alertError(e.message)}i.replaceWith('<i class="fa fa-spin fa-spinner"></i>');n.refreshPrivilegeTable()})};n.launchParentSelector=function(){socket.emit("categories.get",function(e,a){if(e){return app.alertError(e.message)}a=a.filter(function(e){return e&&!e.disabled&&parseInt(e.cid,10)!==parseInt(ajaxify.data.category.cid,10)});templates.parse("partials/category_list",{categories:a},function(e){var t=bootbox.dialog({message:e,title:"[[admin/manage/categories:alert.set-parent-category]]"});t.find("li[data-cid]").on("click",function(){var e=$(this).attr("data-cid");var i={};i[ajaxify.data.category.cid]={parentCid:e};socket.emit("admin.categories.update",i,function(i){if(i){return app.alertError(i.message)}var r=a.filter(function(a){return a&&parseInt(a.cid,10)===parseInt(e,10)});r=r[0];t.modal("hide");$('button[data-action="removeParent"]').parent().removeClass("hide");$('button[data-action="setParent"]').addClass("hide");var n='<i class="fa '+r.icon+'"></i> '+r.name;$('button[data-action="changeParent"]').html(n).parent().removeClass("hide")})})})})};n.addUserToPrivilegeTable=function(){var e=bootbox.dialog({title:"[[admin/manage/categories:alert.find-user]]",message:'<input class="form-control input-lg" placeholder="[[admin/manage/categories:alert.user-search]]" />',show:true});e.on("shown.bs.modal",function(){var a=e.find("input");i.user(a,function(a,t){socket.emit("admin.categories.setPrivilege",{cid:ajaxify.data.category.cid,privilege:["find","read","topics:read"],set:true,member:t.item.user.uid},function(a){if(a){return app.alertError(a.message)}n.refreshPrivilegeTable();e.modal("hide")})})})};n.addGroupToPrivilegeTable=function(){var e=bootbox.dialog({title:"[[admin/manage/categories:alert.find-group]]",message:'<input class="form-control input-lg" placeholder="[[admin/manage/categories:alert.group-search]]" />',show:true});e.on("shown.bs.modal",function(){var a=e.find("input");i.group(a,function(a,t){socket.emit("admin.categories.setPrivilege",{cid:ajaxify.data.category.cid,privilege:["groups:find","groups:read","groups:topics:read"],set:true,member:t.item.group.name},function(a){if(a){return app.alertError(a.message)}n.refreshPrivilegeTable();e.modal("hide")})})})};n.copyPrivilegesToChildren=function(){socket.emit("admin.categories.copyPrivilegesToChildren",ajaxify.data.category.cid,function(e){if(e){return app.alertError(e.message)}app.alertSuccess("Privileges copied!")})};n.copyPrivilegesFromCategory=function(){l(function(e){socket.emit("admin.categories.copyPrivilegesFrom",{toCid:ajaxify.data.category.cid,fromCid:e},function(e){if(e){return app.alertError(e.message)}ajaxify.refresh()})})};function l(e){socket.emit("admin.categories.getNames",function(a,t){if(a){return app.alertError(a.message)}templates.parse("admin/partials/categories/select-category",{categories:t},function(a){r.translate(a,function(a){var t=bootbox.dialog({title:"Select a Category",message:a,buttons:{save:{label:"Copy",className:"btn-primary",callback:i}}});function i(){var a=t.find("form").serializeObject();e(a["select-cid"]);t.modal("hide");return false}t.find("form").on("submit",i)})})})}return n});
//# sourceMappingURL=public/src/admin/manage/category.js.map