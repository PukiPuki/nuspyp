{"version":3,"sources":["public/src/admin/manage/category.js"],"names":["define","uploader","iconSelect","colorpicker","autocomplete","translator","Category","modified_categories","init","$","each","$this","this","val","attr","on","ajaxify","go","enableColorPicker","idx","inputEl","$inputEl","previewEl","parents","find","enable","hsb","hex","css","modified","not","ev","target","which","preventDefault","Object","keys","length","socket","emit","err","result","app","alertError","message","flags","_unsaved","alert","title","join","type","timeout","e","bootbox","confirm","compile","data","category","cid","alertSuccess","selectCategoryModal","fromCid","toCid","refresh","show","route","config","relative_path","params","imageUrlOnServer","previewBox","parent","siblings","Date","getTime","addClass","hide","launchParentSelector","payload","parentCid","removeClass","setupPrivilegeTable","handleTags","el","tagEl","tagsinput","confirmKeys","trimValue","tagWhitelist","forEach","tag","checkboxEl","privilege","state","prop","rowEl","member","isPrivate","parseInt","isGroup","undefined","setPrivilege","addUserToPrivilegeTable","addGroupToPrivilegeTable","copyPrivilegesToChildren","copyPrivilegesFromCategory","exposeAssumedPrivileges","refreshPrivilegeTable","privileges","templates","parse","html","translate","privs","push","getAttribute","x","numPrivs","inputs","checked","indeterminate","set","replaceWith","categories","filter","disabled","modal","dialog","buttonHtml","icon","name","user","ui","item","uid","group","callback","buttons","save","label","className","submit","formData","serializeObject"],"mappings":"AAAA,aAGAA,OAAO,yBACN,WACA,aACA,4BACA,eACA,cACE,SAAUC,EAAUC,EAAYC,EAAaC,EAAcC,GAC7D,IAAIC,KACJ,IAAIC,KAEJD,EAASE,KAAO,WACfC,EAAE,6BAA6BC,KAAK,WACnC,IAAIC,EAAQF,EAAEG,MACdD,EAAME,IAAIF,EAAMG,KAAK,iBAGtBL,EAAE,sBAAsBM,GAAG,SAAU,WACpCC,QAAQC,GAAG,2BAA6BR,EAAEG,MAAMC,SAGjD,SAASK,EAAkBC,EAAKC,GAC/B,IAAIC,EAAWZ,EAAEW,GACjB,IAAIE,EAAYD,EAASE,QAAQ,cAAcC,KAAK,qBAEpDrB,EAAYsB,OAAOJ,EAAU,SAAUK,EAAKC,GAC3C,GAAIN,EAASP,KAAK,eAAiB,UAAW,CAC7CQ,EAAUM,IAAI,mBAAoB,IAAMD,QAClC,GAAIN,EAASP,KAAK,eAAiB,QAAS,CAClDQ,EAAUM,IAAI,QAAS,IAAMD,GAG9BE,EAASR,EAAS,MAKpBZ,EAAE,uDAAuDqB,IAAIrB,EAAE,qCAC7DM,GAAG,SAAU,SAAUgB,GACvBF,EAASE,EAAGC,UAEZjB,GAAG,UAAW,SAAUgB,GACxB,GAAIA,EAAGE,QAAU,GAAI,CACpBF,EAAGG,iBACH,OAAO,SAIVzB,EAAE,4BAA4BM,GAAG,SAAU,WAC1CN,EAAE,qBAAqBmB,IAAI,kBAAmBnB,EAAEG,MAAMC,SAGvDJ,EAAE,8CAA8CC,KAAKQ,GAErDT,EAAE,SAASM,GAAG,QAAS,WACtB,GAAIoB,OAAOC,KAAK7B,GAAqB8B,OAAQ,CAC5CC,OAAOC,KAAK,0BAA2BhC,EAAqB,SAAUiC,EAAKC,GAC1E,GAAID,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAII,SAG3B,GAAIH,GAAUA,EAAOJ,OAAQ,CAC5BK,IAAIG,MAAMC,SAAW,MACrBJ,IAAIK,OACHC,MAAO,qBACPJ,QAAS,gBAAkBH,EAAOQ,KAAK,MAAQ,6BAC/CC,KAAM,UACNC,QAAS,SAIZ5C,KAED,OAAO,QAGRE,EAAE,UAAUM,GAAG,QAAS,SAAUqC,GACjCA,EAAElB,iBAEFmB,QAAQC,QAAQjD,EAAWkD,QAC1B,8CACA9C,EAAE,iBAAiBe,KAAK,2BAA2BX,OACjD,SAAUyC,GACZ,IAAKA,EAAS,CACb,OAEDhB,OAAOC,KAAK,yBAA0BvB,QAAQwC,KAAKC,SAASC,IAAK,SAAUlB,GAC1E,GAAIA,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAII,SAE3BF,IAAIiB,aAAa,mDACjB3C,QAAQC,GAAG,iCAKdR,EAAE,kBAAkBM,GAAG,QAAS,WAC/B6C,EAAoB,SAAUF,GAC7BpB,OAAOC,KAAK,qCAAuCsB,QAASH,EAAKI,MAAO9C,QAAQwC,KAAKC,SAASC,KAAO,SAAUlB,GAC9G,GAAIA,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAII,SAE3BF,IAAIiB,aAAa,kDACjB3C,QAAQ+C,cAGV,OAAO,QAGRtD,EAAE,kBAAkBM,GAAG,QAAS,WAC/B,IAAIK,EAAUX,EAAEG,MAChB,IAAI8C,EAAMtC,EAAQN,KAAK,YAEvBb,EAAS+D,MACRhB,MAAO,iDACPiB,MAAOC,OAAOC,cAAgB,oCAC9BC,QAAUV,IAAKA,IACb,SAAUW,GACZ5D,EAAE,mBAAmBI,IAAIwD,GACzB,IAAIC,EAAalD,EAAQmD,SAASA,SAASC,SAAS,qBACpDF,EAAW1C,IAAI,aAAc,OAASyC,EAAmB,KAAM,IAAII,MAAOC,UAAY,KAEtF7C,EAASpB,EAAE,wBAIbA,EAAE,mBAAmBM,GAAG,SAAU,WACjCN,EAAE,qBAAqBmB,IAAI,mBAAoBnB,EAAEG,MAAMC,MAAS,QAAUJ,EAAEG,MAAMC,MAAQ,KAAQ,MAGnGJ,EAAE,iBAAiBM,GAAG,QAAS,SAAUqC,GACxCA,EAAElB,iBAEF,IAAId,EAAUX,EAAE,mBAChB,IAAI6D,EAAa7D,EAAE,qBAEnBW,EAAQP,IAAI,IACZyD,EAAW1C,IAAI,mBAAoB,IACnCC,EAAST,EAAQ,IACjBX,EAAEG,MAAM2D,SAASI,SAAS,QAAQC,SAGnCnE,EAAE,qBAAqBM,GAAG,QAAS,WAClCb,EAAWM,KAAKC,EAAEG,MAAMY,KAAK,KAAMK,KAGpCpB,EAAE,uEAAuEM,GAAG,QAAST,EAASuE,sBAC9FpE,EAAE,sCAAsCM,GAAG,QAAS,WACnD,IAAI+D,KACJA,EAAQ9D,QAAQwC,KAAKC,SAASC,MAC7BqB,UAAW,GAGZzC,OAAOC,KAAK,0BAA2BuC,EAAS,SAAUtC,GACzD,GAAIA,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAII,SAE3BnC,EAAE,sCAAsC8D,SAASI,SAAS,QAC1DlE,EAAE,sCAAsC8D,SAASI,SAAS,QAC1DlE,EAAE,mCAAmCuE,YAAY,YAInD1E,EAAS2E,sBAETC,KAGD,SAASrD,EAASsD,GACjB,IAAIzB,EAAM1C,QAAQwC,KAAKC,SAASC,IAEhC,GAAIA,EAAK,CACRnD,EAAoBmD,GAAOnD,EAAoBmD,OAC/CnD,EAAoBmD,GAAKjD,EAAE0E,GAAIrE,KAAK,cAAgBL,EAAE0E,GAAItE,MAE1D6B,IAAIG,MAAQH,IAAIG,UAChBH,IAAIG,MAAMC,SAAW,MAIvB,SAASoC,IACR,IAAIE,EAAQ3E,EAAE,kBACd2E,EAAMC,WACLC,aAAc,GAAI,IAClBC,UAAW,OAGZvE,QAAQwC,KAAKC,SAAS+B,aAAaC,QAAQ,SAAUC,GACpDN,EAAMC,UAAU,MAAOK,KAExBN,EAAMrE,GAAG,wBAAyB,WACjCc,EAASuD,KAIX9E,EAAS2E,oBAAsB,WAC9BxE,EAAE,8BAA8BM,GAAG,SAAU,yBAA0B,WACtE,IAAI4E,EAAalF,EAAEG,MACnB,IAAIgF,EAAYD,EAAWpB,SAASzD,KAAK,kBACzC,IAAI+E,EAAQF,EAAWG,KAAK,WAC5B,IAAIC,EAAQJ,EAAWpE,QAAQ,MAC/B,IAAIyE,EAASD,EAAMjF,KAAK,oBAAsBiF,EAAMjF,KAAK,YACzD,IAAImF,EAAYC,SAASH,EAAMjF,KAAK,iBAAmB,EAAG,IAC1D,IAAIqF,EAAUJ,EAAMjF,KAAK,qBAAuBsF,UAEhD,GAAIJ,EAAQ,CACX,GAAIG,GAAWP,IAAc,oBAAsBK,GAAaJ,EAAO,CACtExC,QAAQC,QAAQ,qDAAsD,SAAUA,GAC/E,GAAIA,EAAS,CACZhD,EAAS+F,aAAaL,EAAQJ,EAAWC,EAAOF,OAC1C,CACNA,EAAWG,KAAK,WAAYH,EAAWG,KAAK,mBAGxC,CACNxF,EAAS+F,aAAaL,EAAQJ,EAAWC,EAAOF,QAE3C,CACNjD,IAAIC,WAAW,6BAIjBlC,EAAE,8BAA8BM,GAAG,QAAS,8BAA+BT,EAASgG,yBACpF7F,EAAE,8BAA8BM,GAAG,QAAS,+BAAgCT,EAASiG,0BACrF9F,EAAE,8BAA8BM,GAAG,QAAS,iCAAkCT,EAASkG,0BACvF/F,EAAE,8BAA8BM,GAAG,QAAS,qCAAsCT,EAASmG,4BAE3FnG,EAASoG,2BAGVpG,EAASqG,sBAAwB,WAChCrE,OAAOC,KAAK,wCAAyCvB,QAAQwC,KAAKC,SAASC,IAAK,SAAUlB,EAAKoE,GAC9F,GAAIpE,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAII,SAG3BiE,UAAUC,MAAM,wCACfF,WAAYA,GACV,SAAUG,GACZ1G,EAAW2G,UAAUD,EAAM,SAAUA,GACpCtG,EAAE,8BAA8BsG,KAAKA,GACrCzG,EAASoG,iCAMbpG,EAASoG,wBAA0B,WAMlC,IAAIO,KACJxG,EAAE,qFAAqF8D,SAAS7D,KAAK,SAAUS,EAAKgE,GACnH,GAAI1E,EAAE0E,GAAI3D,KAAK,SAASsE,KAAK,WAAY,CACxCmB,EAAMC,KAAK/B,EAAGgC,aAAa,sBAG7B,IAAK,IAAIC,EAAI,EAAGC,EAAWJ,EAAM5E,OAAQ+E,EAAIC,EAAUD,GAAK,EAAG,CAC9D,IAAIE,EAAS7G,EAAE,gIAAkIwG,EAAMG,GAAK,YAC5JE,EAAO5G,KAAK,SAAUS,EAAKgE,GAC1B,IAAKA,EAAGoC,QAAS,CAChBpC,EAAGqC,cAAgB,UAMvBlH,EAAS+F,aAAe,SAAUL,EAAQJ,EAAWC,EAAOF,GAC3DrD,OAAOC,KAAK,iCACXmB,IAAK1C,QAAQwC,KAAKC,SAASC,IAC3BkC,UAAWA,EACX6B,IAAK5B,EACLG,OAAQA,GACN,SAAUxD,GACZ,GAAIA,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAII,SAG3B+C,EAAW+B,YAAY,yCACvBpH,EAASqG,2BAIXrG,EAASuE,qBAAuB,WAC/BvC,OAAOC,KAAK,iBAAkB,SAAUC,EAAKmF,GAC5C,GAAInF,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAII,SAG3B+E,EAAaA,EAAWC,OAAO,SAAUnE,GACxC,OAAOA,IAAaA,EAASoE,UAAY3B,SAASzC,EAASC,IAAK,MAAQwC,SAASlF,QAAQwC,KAAKC,SAASC,IAAK,MAG7GmD,UAAUC,MAAM,0BACfa,WAAYA,GACV,SAAUZ,GACZ,IAAIe,EAAQzE,QAAQ0E,QACnBnF,QAASmE,EACT/D,MAAO,0DAGR8E,EAAMtG,KAAK,gBAAgBT,GAAG,QAAS,WACtC,IAAIgE,EAAYtE,EAAEG,MAAME,KAAK,YAC7B,IAAIgE,KAEJA,EAAQ9D,QAAQwC,KAAKC,SAASC,MAC7BqB,UAAWA,GAGZzC,OAAOC,KAAK,0BAA2BuC,EAAS,SAAUtC,GACzD,GAAIA,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAII,SAE3B,IAAI2B,EAASoD,EAAWC,OAAO,SAAUnE,GACxC,OAAOA,GAAYyC,SAASzC,EAASC,IAAK,MAAQwC,SAASnB,EAAW,MAEvER,EAASA,EAAO,GAEhBuD,EAAMA,MAAM,QACZrH,EAAE,sCAAsC8D,SAASS,YAAY,QAC7DvE,EAAE,mCAAmCkE,SAAS,QAC9C,IAAIqD,EAAa,gBAAkBzD,EAAO0D,KAAO,UAAY1D,EAAO2D,KACpEzH,EAAE,sCAAsCsG,KAAKiB,GAAYzD,SAASS,YAAY,iBAOnF1E,EAASgG,wBAA0B,WAClC,IAAIwB,EAAQzE,QAAQ0E,QACnB/E,MAAO,8CACPJ,QAAS,sGACToB,KAAM,OAGP8D,EAAM/G,GAAG,iBAAkB,WAC1B,IAAIK,EAAU0G,EAAMtG,KAAK,SAEzBpB,EAAa+H,KAAK/G,EAAS,SAAUW,EAAIqG,GACxC9F,OAAOC,KAAK,iCACXmB,IAAK1C,QAAQwC,KAAKC,SAASC,IAC3BkC,WAAY,OAAQ,OAAQ,eAC5B6B,IAAK,KACLzB,OAAQoC,EAAGC,KAAKF,KAAKG,KACnB,SAAU9F,GACZ,GAAIA,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAII,SAG3BtC,EAASqG,wBACTmB,EAAMA,MAAM,eAMhBxH,EAASiG,yBAA2B,WACnC,IAAIuB,EAAQzE,QAAQ0E,QACnB/E,MAAO,+CACPJ,QAAS,uGACToB,KAAM,OAGP8D,EAAM/G,GAAG,iBAAkB,WAC1B,IAAIK,EAAU0G,EAAMtG,KAAK,SAEzBpB,EAAamI,MAAMnH,EAAS,SAAUW,EAAIqG,GACzC9F,OAAOC,KAAK,iCACXmB,IAAK1C,QAAQwC,KAAKC,SAASC,IAC3BkC,WAAY,cAAe,cAAe,sBAC1C6B,IAAK,KACLzB,OAAQoC,EAAGC,KAAKE,MAAML,MACpB,SAAU1F,GACZ,GAAIA,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAII,SAG3BtC,EAASqG,wBACTmB,EAAMA,MAAM,eAMhBxH,EAASkG,yBAA2B,WACnClE,OAAOC,KAAK,4CAA6CvB,QAAQwC,KAAKC,SAASC,IAAK,SAAUlB,GAC7F,GAAIA,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAII,SAE3BF,IAAIiB,aAAa,yBAInBrD,EAASmG,2BAA6B,WACrC7C,EAAoB,SAAUF,GAC7BpB,OAAOC,KAAK,uCAAyCuB,MAAO9C,QAAQwC,KAAKC,SAASC,IAAKG,QAASH,GAAO,SAAUlB,GAChH,GAAIA,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAII,SAE3B5B,QAAQ+C,eAKX,SAASH,EAAoB4E,GAC5BlG,OAAOC,KAAK,4BAA6B,SAAUC,EAAKmF,GACvD,GAAInF,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAII,SAG3BiE,UAAUC,MAAM,6CACfa,WAAYA,GACV,SAAUZ,GACZ1G,EAAW2G,UAAUD,EAAM,SAAUA,GACpC,IAAIe,EAAQzE,QAAQ0E,QACnB/E,MAAO,oBACPJ,QAASmE,EACT0B,SACCC,MACCC,MAAO,OACPC,UAAW,cACXJ,SAAUK,MAKb,SAASA,IACR,IAAIC,EAAWhB,EAAMtG,KAAK,QAAQuH,kBAClCP,EAASM,EAAS,eAClBhB,EAAMA,MAAM,QACZ,OAAO,MAGRA,EAAMtG,KAAK,QAAQT,GAAG,SAAU8H,SAMpC,OAAOvI","file":"public/src/admin/manage/category.js","sourcesContent":["'use strict';\n\n\ndefine('admin/manage/category', [\n\t'uploader',\n\t'iconSelect',\n\t'admin/modules/colorpicker',\n\t'autocomplete',\n\t'translator',\n], function (uploader, iconSelect, colorpicker, autocomplete, translator) {\n\tvar\tCategory = {};\n\tvar modified_categories = {};\n\n\tCategory.init = function () {\n\t\t$('#category-settings select').each(function () {\n\t\t\tvar $this = $(this);\n\t\t\t$this.val($this.attr('data-value'));\n\t\t});\n\n\t\t$('#category-selector').on('change', function () {\n\t\t\tajaxify.go('admin/manage/categories/' + $(this).val());\n\t\t});\n\n\t\tfunction enableColorPicker(idx, inputEl) {\n\t\t\tvar $inputEl = $(inputEl);\n\t\t\tvar previewEl = $inputEl.parents('[data-cid]').find('.category-preview');\n\n\t\t\tcolorpicker.enable($inputEl, function (hsb, hex) {\n\t\t\t\tif ($inputEl.attr('data-name') === 'bgColor') {\n\t\t\t\t\tpreviewEl.css('background-color', '#' + hex);\n\t\t\t\t} else if ($inputEl.attr('data-name') === 'color') {\n\t\t\t\t\tpreviewEl.css('color', '#' + hex);\n\t\t\t\t}\n\n\t\t\t\tmodified($inputEl[0]);\n\t\t\t});\n\t\t}\n\n\n\t\t$('#category-settings input, #category-settings select').not($('.privilege-table-container input'))\n\t\t\t.on('change', function (ev) {\n\t\t\t\tmodified(ev.target);\n\t\t\t})\n\t\t\t.on('keydown', function (ev) {\n\t\t\t\tif (ev.which === 13) {\n\t\t\t\t\tev.preventDefault();\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t});\n\n\t\t$('[data-name=\"imageClass\"]').on('change', function () {\n\t\t\t$('.category-preview').css('background-size', $(this).val());\n\t\t});\n\n\t\t$('[data-name=\"bgColor\"], [data-name=\"color\"]').each(enableColorPicker);\n\n\t\t$('#save').on('click', function () {\n\t\t\tif (Object.keys(modified_categories).length) {\n\t\t\t\tsocket.emit('admin.categories.update', modified_categories, function (err, result) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (result && result.length) {\n\t\t\t\t\t\tapp.flags._unsaved = false;\n\t\t\t\t\t\tapp.alert({\n\t\t\t\t\t\t\ttitle: 'Updated Categories',\n\t\t\t\t\t\t\tmessage: 'Category IDs ' + result.join(', ') + ' was successfully updated.',\n\t\t\t\t\t\t\ttype: 'success',\n\t\t\t\t\t\t\ttimeout: 2000,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tmodified_categories = {};\n\t\t\t}\n\t\t\treturn false;\n\t\t});\n\n\t\t$('.purge').on('click', function (e) {\n\t\t\te.preventDefault();\n\n\t\t\tbootbox.confirm(translator.compile(\n\t\t\t\t'admin/manage/categories:alert.confirm-purge',\n\t\t\t\t$('form.category').find('input[data-name=\"name\"]').val()\n\t\t\t), function (confirm) {\n\t\t\t\tif (!confirm) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tsocket.emit('admin.categories.purge', ajaxify.data.category.cid, function (err) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t\t}\n\t\t\t\t\tapp.alertSuccess('[[admin/manage/categories:alert.purge-success]]');\n\t\t\t\t\tajaxify.go('admin/manage/categories');\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\t$('.copy-settings').on('click', function () {\n\t\t\tselectCategoryModal(function (cid) {\n\t\t\t\tsocket.emit('admin.categories.copySettingsFrom', { fromCid: cid, toCid: ajaxify.data.category.cid }, function (err) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t\t}\n\t\t\t\t\tapp.alertSuccess('[[admin/manage/categories:alert.copy-success]]');\n\t\t\t\t\tajaxify.refresh();\n\t\t\t\t});\n\t\t\t});\n\t\t\treturn false;\n\t\t});\n\n\t\t$('.upload-button').on('click', function () {\n\t\t\tvar inputEl = $(this);\n\t\t\tvar cid = inputEl.attr('data-cid');\n\n\t\t\tuploader.show({\n\t\t\t\ttitle: '[[admin/manage/categories:alert.upload-image]]',\n\t\t\t\troute: config.relative_path + '/api/admin/category/uploadpicture',\n\t\t\t\tparams: { cid: cid },\n\t\t\t}, function (imageUrlOnServer) {\n\t\t\t\t$('#category-image').val(imageUrlOnServer);\n\t\t\t\tvar previewBox = inputEl.parent().parent().siblings('.category-preview');\n\t\t\t\tpreviewBox.css('background', 'url(' + imageUrlOnServer + '?' + new Date().getTime() + ')');\n\n\t\t\t\tmodified($('#category-image'));\n\t\t\t});\n\t\t});\n\n\t\t$('#category-image').on('change', function () {\n\t\t\t$('.category-preview').css('background-image', $(this).val() ? ('url(\"' + $(this).val() + '\")') : '');\n\t\t});\n\n\t\t$('.delete-image').on('click', function (e) {\n\t\t\te.preventDefault();\n\n\t\t\tvar inputEl = $('#category-image');\n\t\t\tvar previewBox = $('.category-preview');\n\n\t\t\tinputEl.val('');\n\t\t\tpreviewBox.css('background-image', '');\n\t\t\tmodified(inputEl[0]);\n\t\t\t$(this).parent().addClass('hide').hide();\n\t\t});\n\n\t\t$('.category-preview').on('click', function () {\n\t\t\ticonSelect.init($(this).find('i'), modified);\n\t\t});\n\n\t\t$('button[data-action=\"setParent\"], button[data-action=\"changeParent\"]').on('click', Category.launchParentSelector);\n\t\t$('button[data-action=\"removeParent\"]').on('click', function () {\n\t\t\tvar payload = {};\n\t\t\tpayload[ajaxify.data.category.cid] = {\n\t\t\t\tparentCid: 0,\n\t\t\t};\n\n\t\t\tsocket.emit('admin.categories.update', payload, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t\t$('button[data-action=\"removeParent\"]').parent().addClass('hide');\n\t\t\t\t$('button[data-action=\"changeParent\"]').parent().addClass('hide');\n\t\t\t\t$('button[data-action=\"setParent\"]').removeClass('hide');\n\t\t\t});\n\t\t});\n\n\t\tCategory.setupPrivilegeTable();\n\n\t\thandleTags();\n\t};\n\n\tfunction modified(el) {\n\t\tvar cid = ajaxify.data.category.cid;\n\n\t\tif (cid) {\n\t\t\tmodified_categories[cid] = modified_categories[cid] || {};\n\t\t\tmodified_categories[cid][$(el).attr('data-name')] = $(el).val();\n\n\t\t\tapp.flags = app.flags || {};\n\t\t\tapp.flags._unsaved = true;\n\t\t}\n\t}\n\n\tfunction handleTags() {\n\t\tvar tagEl = $('#tag-whitelist');\n\t\ttagEl.tagsinput({\n\t\t\tconfirmKeys: [13, 44],\n\t\t\ttrimValue: true,\n\t\t});\n\n\t\tajaxify.data.category.tagWhitelist.forEach(function (tag) {\n\t\t\ttagEl.tagsinput('add', tag);\n\t\t});\n\t\ttagEl.on('itemAdded itemRemoved', function () {\n\t\t\tmodified(tagEl);\n\t\t});\n\t}\n\n\tCategory.setupPrivilegeTable = function () {\n\t\t$('.privilege-table-container').on('change', 'input[type=\"checkbox\"]', function () {\n\t\t\tvar checkboxEl = $(this);\n\t\t\tvar privilege = checkboxEl.parent().attr('data-privilege');\n\t\t\tvar state = checkboxEl.prop('checked');\n\t\t\tvar rowEl = checkboxEl.parents('tr');\n\t\t\tvar member = rowEl.attr('data-group-name') || rowEl.attr('data-uid');\n\t\t\tvar isPrivate = parseInt(rowEl.attr('data-private') || 0, 10);\n\t\t\tvar isGroup = rowEl.attr('data-group-name') !== undefined;\n\n\t\t\tif (member) {\n\t\t\t\tif (isGroup && privilege === 'groups:moderate' && !isPrivate && state) {\n\t\t\t\t\tbootbox.confirm('[[admin/manage/categories:alert.confirm-moderate]]', function (confirm) {\n\t\t\t\t\t\tif (confirm) {\n\t\t\t\t\t\t\tCategory.setPrivilege(member, privilege, state, checkboxEl);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tcheckboxEl.prop('checked', !checkboxEl.prop('checked'));\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tCategory.setPrivilege(member, privilege, state, checkboxEl);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tapp.alertError('[[error:invalid-data]]');\n\t\t\t}\n\t\t});\n\n\t\t$('.privilege-table-container').on('click', '[data-action=\"search.user\"]', Category.addUserToPrivilegeTable);\n\t\t$('.privilege-table-container').on('click', '[data-action=\"search.group\"]', Category.addGroupToPrivilegeTable);\n\t\t$('.privilege-table-container').on('click', '[data-action=\"copyToChildren\"]', Category.copyPrivilegesToChildren);\n\t\t$('.privilege-table-container').on('click', '[data-action=\"copyPrivilegesFrom\"]', Category.copyPrivilegesFromCategory);\n\n\t\tCategory.exposeAssumedPrivileges();\n\t};\n\n\tCategory.refreshPrivilegeTable = function () {\n\t\tsocket.emit('admin.categories.getPrivilegeSettings', ajaxify.data.category.cid, function (err, privileges) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\ttemplates.parse('admin/partials/categories/privileges', {\n\t\t\t\tprivileges: privileges,\n\t\t\t}, function (html) {\n\t\t\t\ttranslator.translate(html, function (html) {\n\t\t\t\t\t$('.privilege-table-container').html(html);\n\t\t\t\t\tCategory.exposeAssumedPrivileges();\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tCategory.exposeAssumedPrivileges = function () {\n\t\t/*\n\t\t\tIf registered-users has a privilege enabled, then all users and groups of that privilege\n\t\t\tshould be assumed to have that privilege as well, even if not set in the db, so reflect\n\t\t\tthis arrangement in the table\n\t\t*/\n\t\tvar privs = [];\n\t\t$('.privilege-table tr[data-group-name=\"registered-users\"] td input[type=\"checkbox\"]').parent().each(function (idx, el) {\n\t\t\tif ($(el).find('input').prop('checked')) {\n\t\t\t\tprivs.push(el.getAttribute('data-privilege'));\n\t\t\t}\n\t\t});\n\t\tfor (var x = 0, numPrivs = privs.length; x < numPrivs; x += 1) {\n\t\t\tvar inputs = $('.privilege-table tr[data-group-name]:not([data-group-name=\"registered-users\"],[data-group-name=\"guests\"]) td[data-privilege=\"' + privs[x] + '\"] input');\n\t\t\tinputs.each(function (idx, el) {\n\t\t\t\tif (!el.checked) {\n\t\t\t\t\tel.indeterminate = true;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n\n\tCategory.setPrivilege = function (member, privilege, state, checkboxEl) {\n\t\tsocket.emit('admin.categories.setPrivilege', {\n\t\t\tcid: ajaxify.data.category.cid,\n\t\t\tprivilege: privilege,\n\t\t\tset: state,\n\t\t\tmember: member,\n\t\t}, function (err) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tcheckboxEl.replaceWith('<i class=\"fa fa-spin fa-spinner\"></i>');\n\t\t\tCategory.refreshPrivilegeTable();\n\t\t});\n\t};\n\n\tCategory.launchParentSelector = function () {\n\t\tsocket.emit('categories.get', function (err, categories) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tcategories = categories.filter(function (category) {\n\t\t\t\treturn category && !category.disabled && parseInt(category.cid, 10) !== parseInt(ajaxify.data.category.cid, 10);\n\t\t\t});\n\n\t\t\ttemplates.parse('partials/category_list', {\n\t\t\t\tcategories: categories,\n\t\t\t}, function (html) {\n\t\t\t\tvar modal = bootbox.dialog({\n\t\t\t\t\tmessage: html,\n\t\t\t\t\ttitle: '[[admin/manage/categories:alert.set-parent-category]]',\n\t\t\t\t});\n\n\t\t\t\tmodal.find('li[data-cid]').on('click', function () {\n\t\t\t\t\tvar parentCid = $(this).attr('data-cid');\n\t\t\t\t\tvar payload = {};\n\n\t\t\t\t\tpayload[ajaxify.data.category.cid] = {\n\t\t\t\t\t\tparentCid: parentCid,\n\t\t\t\t\t};\n\n\t\t\t\t\tsocket.emit('admin.categories.update', payload, function (err) {\n\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tvar parent = categories.filter(function (category) {\n\t\t\t\t\t\t\treturn category && parseInt(category.cid, 10) === parseInt(parentCid, 10);\n\t\t\t\t\t\t});\n\t\t\t\t\t\tparent = parent[0];\n\n\t\t\t\t\t\tmodal.modal('hide');\n\t\t\t\t\t\t$('button[data-action=\"removeParent\"]').parent().removeClass('hide');\n\t\t\t\t\t\t$('button[data-action=\"setParent\"]').addClass('hide');\n\t\t\t\t\t\tvar buttonHtml = '<i class=\"fa ' + parent.icon + '\"></i> ' + parent.name;\n\t\t\t\t\t\t$('button[data-action=\"changeParent\"]').html(buttonHtml).parent().removeClass('hide');\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tCategory.addUserToPrivilegeTable = function () {\n\t\tvar modal = bootbox.dialog({\n\t\t\ttitle: '[[admin/manage/categories:alert.find-user]]',\n\t\t\tmessage: '<input class=\"form-control input-lg\" placeholder=\"[[admin/manage/categories:alert.user-search]]\" />',\n\t\t\tshow: true,\n\t\t});\n\n\t\tmodal.on('shown.bs.modal', function () {\n\t\t\tvar inputEl = modal.find('input');\n\n\t\t\tautocomplete.user(inputEl, function (ev, ui) {\n\t\t\t\tsocket.emit('admin.categories.setPrivilege', {\n\t\t\t\t\tcid: ajaxify.data.category.cid,\n\t\t\t\t\tprivilege: ['find', 'read', 'topics:read'],\n\t\t\t\t\tset: true,\n\t\t\t\t\tmember: ui.item.user.uid,\n\t\t\t\t}, function (err) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t\t}\n\n\t\t\t\t\tCategory.refreshPrivilegeTable();\n\t\t\t\t\tmodal.modal('hide');\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tCategory.addGroupToPrivilegeTable = function () {\n\t\tvar modal = bootbox.dialog({\n\t\t\ttitle: '[[admin/manage/categories:alert.find-group]]',\n\t\t\tmessage: '<input class=\"form-control input-lg\" placeholder=\"[[admin/manage/categories:alert.group-search]]\" />',\n\t\t\tshow: true,\n\t\t});\n\n\t\tmodal.on('shown.bs.modal', function () {\n\t\t\tvar inputEl = modal.find('input');\n\n\t\t\tautocomplete.group(inputEl, function (ev, ui) {\n\t\t\t\tsocket.emit('admin.categories.setPrivilege', {\n\t\t\t\t\tcid: ajaxify.data.category.cid,\n\t\t\t\t\tprivilege: ['groups:find', 'groups:read', 'groups:topics:read'],\n\t\t\t\t\tset: true,\n\t\t\t\t\tmember: ui.item.group.name,\n\t\t\t\t}, function (err) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t\t}\n\n\t\t\t\t\tCategory.refreshPrivilegeTable();\n\t\t\t\t\tmodal.modal('hide');\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tCategory.copyPrivilegesToChildren = function () {\n\t\tsocket.emit('admin.categories.copyPrivilegesToChildren', ajaxify.data.category.cid, function (err) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\t\t\tapp.alertSuccess('Privileges copied!');\n\t\t});\n\t};\n\n\tCategory.copyPrivilegesFromCategory = function () {\n\t\tselectCategoryModal(function (cid) {\n\t\t\tsocket.emit('admin.categories.copyPrivilegesFrom', { toCid: ajaxify.data.category.cid, fromCid: cid }, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t\tajaxify.refresh();\n\t\t\t});\n\t\t});\n\t};\n\n\tfunction selectCategoryModal(callback) {\n\t\tsocket.emit('admin.categories.getNames', function (err, categories) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\ttemplates.parse('admin/partials/categories/select-category', {\n\t\t\t\tcategories: categories,\n\t\t\t}, function (html) {\n\t\t\t\ttranslator.translate(html, function (html) {\n\t\t\t\t\tvar modal = bootbox.dialog({\n\t\t\t\t\t\ttitle: 'Select a Category',\n\t\t\t\t\t\tmessage: html,\n\t\t\t\t\t\tbuttons: {\n\t\t\t\t\t\t\tsave: {\n\t\t\t\t\t\t\t\tlabel: 'Copy',\n\t\t\t\t\t\t\t\tclassName: 'btn-primary',\n\t\t\t\t\t\t\t\tcallback: submit,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\n\t\t\t\t\tfunction submit() {\n\t\t\t\t\t\tvar formData = modal.find('form').serializeObject();\n\t\t\t\t\t\tcallback(formData['select-cid']);\n\t\t\t\t\t\tmodal.modal('hide');\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tmodal.find('form').on('submit', submit);\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n\n\treturn Category;\n});\n"]}