{"version":3,"sources":["public/src/client/topic.js"],"names":["define","infinitescroll","threadTools","postTools","events","posts","images","replies","navigator","sort","components","storage","Topic","currentUrl","$","window","on","ev","data","replaceURLTimeout","clearTimeout","ajaxify","currentPage","url","disable","get","find","text","hide","app","removeAlert","removeListeners","off","onKeyDown","startsWith","require","search","topicDOM","active","end","init","tid","trigger","enterRoom","processPage","handleSort","slug","config","usePagination","loadMorePosts","addBlockQuoteHandler","addParentHandler","handleKeys","postcount","toTop","toBottom","navigatorCallback","calculateIndex","handleBookmark","updateTopicTitle","handleTopicSearch","target","nodeName","shiftKey","ctrlKey","altKey","which","mousetrap","prev","next","bind","e","topicSearchEnabled","match","preventDefault","val","prepareSearch","scrollTop","socket","emit","err","postCount","alertError","message","topicPostSort","scrollBottom","bookmark","getItem","postIndex","getPostIndex","location","indexOf","length","scrollToPostIndex","pagination","bookmarkThreshold","alert","alert_id","timeout","type","clickfn","scrollToIndex","parseInt","closefn","removeItem","setTimeout","parts","pathname","split","lastPart","utils","isNumber","Math","max","last","attr","blockQuote","this","parent","toggle","toggleClass","collapsed","hasClass","toPid","toPost","span","html","title","removeClass","addClass","index","elementCount","threshold","path","removeRelativePath","slice","scrollActive","loadImages","newUrl","user","uid","updateUserBookmark","history","replaceState","test","protocol","host","RELATIVE_PATH","bookmarkKey","currentBookmark","setItem"],"mappings":"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","file":"public/src/client/topic.js","sourcesContent":["'use strict';\n\n\ndefine('forum/topic', [\n\t'forum/infinitescroll',\n\t'forum/topic/threadTools',\n\t'forum/topic/postTools',\n\t'forum/topic/events',\n\t'forum/topic/posts',\n\t'forum/topic/images',\n\t'forum/topic/replies',\n\t'navigator',\n\t'sort',\n\t'components',\n\t'storage',\n], function (infinitescroll, threadTools, postTools, events, posts, images, replies, navigator, sort, components, storage) {\n\tvar\tTopic = {};\n\tvar currentUrl = '';\n\n\t$(window).on('action:ajaxify.start', function (ev, data) {\n\t\tif (Topic.replaceURLTimeout) {\n\t\t\tclearTimeout(Topic.replaceURLTimeout);\n\t\t\tTopic.replaceURLTimeout = 0;\n\t\t}\n\n\t\tif (ajaxify.currentPage !== data.url) {\n\t\t\tnavigator.disable();\n\t\t\tcomponents.get('navbar/title').find('span').text('').hide();\n\t\t\tapp.removeAlert('bookmark');\n\n\t\t\tevents.removeListeners();\n\t\t\t$(window).off('keydown', onKeyDown);\n\t\t}\n\n\t\tif (data.url && !data.url.startsWith('topic/')) {\n\t\t\trequire(['search'], function (search) {\n\t\t\t\tif (search.topicDOM.active) {\n\t\t\t\t\tsearch.topicDOM.end();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t});\n\n\tTopic.init = function () {\n\t\tvar tid = ajaxify.data.tid;\n\n\t\t$(window).trigger('action:topic.loading');\n\n\t\tapp.enterRoom('topic_' + tid);\n\n\t\tposts.processPage(components.get('post'));\n\n\t\tpostTools.init(tid);\n\t\tthreadTools.init(tid);\n\t\treplies.init(tid);\n\t\tevents.init();\n\n\t\tsort.handleSort('topicPostSort', 'user.setTopicSort', 'topic/' + ajaxify.data.slug);\n\n\t\tif (!config.usePagination) {\n\t\t\tinfinitescroll.init($('[component=\"topic\"]'), posts.loadMorePosts);\n\t\t}\n\n\t\taddBlockQuoteHandler();\n\n\t\taddParentHandler();\n\n\t\thandleKeys();\n\n\t\tnavigator.init('[component=\"post\"]', ajaxify.data.postcount, Topic.toTop, Topic.toBottom, Topic.navigatorCallback, Topic.calculateIndex);\n\n\t\thandleBookmark(tid);\n\n\t\t$(window).on('scroll', updateTopicTitle);\n\n\t\thandleTopicSearch();\n\n\t\t$(window).trigger('action:topic.loaded', ajaxify.data);\n\t};\n\n\tfunction handleKeys() {\n\t\tif (!config.usePagination) {\n\t\t\t$(window).off('keydown', onKeyDown).on('keydown', onKeyDown);\n\t\t}\n\t}\n\n\tfunction onKeyDown(ev) {\n\t\tif (ev.target.nodeName === 'BODY') {\n\t\t\tif (ev.shiftKey || ev.ctrlKey || ev.altKey) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (ev.which === 36) { // home key\n\t\t\t\tTopic.toTop();\n\t\t\t\treturn false;\n\t\t\t} else if (ev.which === 35) { // end key\n\t\t\t\tTopic.toBottom();\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t}\n\n\tfunction handleTopicSearch() {\n\t\trequire(['search', 'mousetrap'], function (search, mousetrap) {\n\t\t\t$('.topic-search')\n\t\t\t\t.on('click', '.prev', function () {\n\t\t\t\t\tsearch.topicDOM.prev();\n\t\t\t\t})\n\t\t\t\t.on('click', '.next', function () {\n\t\t\t\t\tsearch.topicDOM.next();\n\t\t\t\t});\n\n\t\t\tmousetrap.bind('ctrl+f', function (e) {\n\t\t\t\tif (config.topicSearchEnabled) {\n\t\t\t\t\t// If in topic, open search window and populate, otherwise regular behaviour\n\t\t\t\t\tvar match = ajaxify.currentPage.match(/^topic\\/([\\d]+)/);\n\t\t\t\t\tvar tid;\n\t\t\t\t\tif (match) {\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\ttid = match[1];\n\t\t\t\t\t\t$('#search-fields input').val('in:topic-' + tid + ' ');\n\t\t\t\t\t\tapp.prepareSearch();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tTopic.toTop = function () {\n\t\tnavigator.scrollTop(0);\n\t};\n\n\tTopic.toBottom = function () {\n\t\tsocket.emit('topics.postcount', ajaxify.data.tid, function (err, postCount) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\t\t\tif (config.topicPostSort !== 'oldest_to_newest') {\n\t\t\t\tpostCount = 2;\n\t\t\t}\n\t\t\tnavigator.scrollBottom(postCount - 1);\n\t\t});\n\t};\n\n\tfunction handleBookmark(tid) {\n\t\t// use the user's bookmark data if available, fallback to local if available\n\t\tvar bookmark = ajaxify.data.bookmark || storage.getItem('topic:' + tid + ':bookmark');\n\t\tvar postIndex = getPostIndex();\n\n\t\tif (postIndex && window.location.search.indexOf('page=') === -1) {\n\t\t\tif (components.get('post/anchor', postIndex).length) {\n\t\t\t\treturn navigator.scrollToPostIndex(postIndex, true, 0);\n\t\t\t}\n\t\t} else if (bookmark && (!config.usePagination || (config.usePagination && ajaxify.data.pagination.currentPage === 1)) && ajaxify.data.postcount > ajaxify.data.bookmarkThreshold) {\n\t\t\tapp.alert({\n\t\t\t\talert_id: 'bookmark',\n\t\t\t\tmessage: '[[topic:bookmark_instructions]]',\n\t\t\t\ttimeout: 0,\n\t\t\t\ttype: 'info',\n\t\t\t\tclickfn: function () {\n\t\t\t\t\tnavigator.scrollToIndex(parseInt(bookmark - 1, 10), true);\n\t\t\t\t},\n\t\t\t\tclosefn: function () {\n\t\t\t\t\tstorage.removeItem('topic:' + tid + ':bookmark');\n\t\t\t\t},\n\t\t\t});\n\t\t\tsetTimeout(function () {\n\t\t\t\tapp.removeAlert('bookmark');\n\t\t\t}, 10000);\n\t\t}\n\t}\n\n\tfunction getPostIndex() {\n\t\tvar parts = window.location.pathname.split('/');\n\t\tvar lastPart = parts[parts.length - 1];\n\t\tif (lastPart && utils.isNumber(lastPart)) {\n\t\t\tlastPart = Math.max(0, parseInt(lastPart, 10) - 1);\n\t\t} else {\n\t\t\treturn 0;\n\t\t}\n\n\t\tif (lastPart > 0 && !components.get('post/anchor', lastPart).length) {\n\t\t\treturn components.get('post/anchor').last().attr('name');\n\t\t}\n\n\t\treturn lastPart;\n\t}\n\n\tfunction addBlockQuoteHandler() {\n\t\tcomponents.get('topic').on('click', 'blockquote .toggle', function () {\n\t\t\tvar blockQuote = $(this).parent('blockquote');\n\t\t\tvar toggle = $(this);\n\t\t\tblockQuote.toggleClass('uncollapsed');\n\t\t\tvar collapsed = !blockQuote.hasClass('uncollapsed');\n\t\t\ttoggle.toggleClass('fa-angle-down', collapsed).toggleClass('fa-angle-up', !collapsed);\n\t\t});\n\t}\n\n\tfunction addParentHandler() {\n\t\tcomponents.get('topic').on('click', '[component=\"post/parent\"]', function (e) {\n\t\t\tvar toPid = $(this).attr('data-topid');\n\n\t\t\tvar toPost = $('[component=\"post\"][data-pid=\"' + toPid + '\"]');\n\t\t\tif (toPost.length) {\n\t\t\t\te.preventDefault();\n\t\t\t\tnavigator.scrollToIndex(toPost.attr('data-index'), true);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction updateTopicTitle() {\n\t\tvar span = components.get('navbar/title').find('span');\n\t\tif ($(window).scrollTop() > 50 && span.hasClass('hidden')) {\n\t\t\tspan.html(ajaxify.data.title).removeClass('hidden');\n\t\t} else if ($(window).scrollTop() <= 50 && !span.hasClass('hidden')) {\n\t\t\tspan.html('').addClass('hidden');\n\t\t}\n\t\tif ($(window).scrollTop() > 300) {\n\t\t\tapp.removeAlert('bookmark');\n\t\t}\n\t}\n\n\tTopic.calculateIndex = function (index, elementCount) {\n\t\tif (index !== 1 && config.topicPostSort !== 'oldest_to_newest') {\n\t\t\treturn elementCount - index + 2;\n\t\t}\n\t\treturn index;\n\t};\n\n\tTopic.navigatorCallback = function (index, elementCount, threshold) {\n\t\tvar path = ajaxify.removeRelativePath(window.location.pathname.slice(1));\n\t\tif (!path.startsWith('topic')) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (navigator.scrollActive) {\n\t\t\treturn;\n\t\t}\n\n\t\timages.loadImages(threshold);\n\n\t\tvar newUrl = 'topic/' + ajaxify.data.slug + (index > 1 ? ('/' + index) : '');\n\n\t\tif (newUrl !== currentUrl) {\n\t\t\tif (Topic.replaceURLTimeout) {\n\t\t\t\tclearTimeout(Topic.replaceURLTimeout);\n\t\t\t}\n\n\t\t\tTopic.replaceURLTimeout = setTimeout(function () {\n\t\t\t\tif (index >= elementCount && app.user.uid) {\n\t\t\t\t\tsocket.emit('topics.markAsRead', [ajaxify.data.tid]);\n\t\t\t\t}\n\n\t\t\t\tupdateUserBookmark(index);\n\n\t\t\t\tTopic.replaceURLTimeout = 0;\n\t\t\t\tif (history.replaceState) {\n\t\t\t\t\tvar search = window.location.search || '';\n\t\t\t\t\tif (!config.usePagination) {\n\t\t\t\t\t\tsearch = (search && !/^\\?page=\\d+$/.test(search) ? search : '');\n\t\t\t\t\t}\n\n\t\t\t\t\thistory.replaceState({\n\t\t\t\t\t\turl: newUrl + search,\n\t\t\t\t\t}, null, window.location.protocol + '//' + window.location.host + RELATIVE_PATH + '/' + newUrl + search);\n\t\t\t\t}\n\t\t\t\tcurrentUrl = newUrl;\n\t\t\t}, 500);\n\t\t}\n\t};\n\n\tfunction updateUserBookmark(index) {\n\t\tvar bookmarkKey = 'topic:' + ajaxify.data.tid + ':bookmark';\n\t\tvar currentBookmark = ajaxify.data.bookmark || storage.getItem(bookmarkKey);\n\n\t\tif (ajaxify.data.postcount > ajaxify.data.bookmarkThreshold && (!currentBookmark || parseInt(index, 10) > parseInt(currentBookmark, 10))) {\n\t\t\tif (app.user.uid) {\n\t\t\t\tsocket.emit('topics.bookmark', {\n\t\t\t\t\ttid: ajaxify.data.tid,\n\t\t\t\t\tindex: index,\n\t\t\t\t}, function (err) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t\t}\n\t\t\t\t\tajaxify.data.bookmark = index;\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tstorage.setItem(bookmarkKey, index);\n\t\t\t}\n\t\t}\n\n\t\t// removes the bookmark alert when we get to / past the bookmark\n\t\tif (!currentBookmark || parseInt(index, 10) >= parseInt(currentBookmark, 10)) {\n\t\t\tapp.removeAlert('bookmark');\n\t\t}\n\t}\n\n\n\treturn Topic;\n});\n"]}