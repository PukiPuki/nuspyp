{"version":3,"sources":["public/src/client/category.js"],"names":["define","infinitescroll","share","navigator","categoryTools","sort","components","translator","topicSelect","pagination","storage","Category","$","window","on","ev","data","ajaxify","currentPage","url","disable","removeListeners","socket","removeListener","onNewTopic","init","cid","app","enterRoom","addShareHandlers","name","handleSort","slug","enableInfiniteLoadingOrPagination","clickedIndex","this","parents","attr","each","index","el","offset","top","scrollTop","setItem","handleScrollToTopicIndex","handleIgnoreWatch","trigger","topics","parts","location","pathname","split","topicIndex","length","utils","isNumber","Math","max","parseInt","search","indexOf","scrollToElement","$this","command","emit","err","alertError","message","toggleClass","alertSuccess","toTop","toBottom","count","scrollBottom","navigatorCallback","topIndex","bottomIndex","template","category","bookmarkIndex","getItem","config","usePagination","page","ceil","topicsPerPage","loadPage","scrollToTopic","highlightTopic","empty","loadTopicsAfter","one","highlight","get","hasClass","addClass","setTimeout","removeClass","duration","scrollTo","animate","undefined","update","topic_count","loadMoreTopics","topic","editable","templates","parse","privileges","showSelect","html","translate","translatedHTML","container","numTopics","noTopicsWarning","remove","widgets","render","slice","x","pinned","insertBefore","insertAfter","append","hide","fadeIn","find","timeago","createUserTooltips","updateTopicCount","topicCount","setCount","direction","children","afterEl","last","first","after","callback","params","loadMore","author","tag","categoryTopicSort","done","onTopicsLoaded","removeAlreadyAddedTopics","filter","tid","before","parseAndTranslate","height","document","getSelectedTids","removeExtra","makeNumbersHumanReadable"],"mappings":"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","file":"public/src/client/category.js","sourcesContent":["'use strict';\n\n\ndefine('forum/category', [\n\t'forum/infinitescroll',\n\t'share',\n\t'navigator',\n\t'forum/category/tools',\n\t'sort',\n\t'components',\n\t'translator',\n\t'topicSelect',\n\t'forum/pagination',\n\t'storage',\n], function (infinitescroll, share, navigator, categoryTools, sort, components, translator, topicSelect, pagination, storage) {\n\tvar Category = {};\n\n\t$(window).on('action:ajaxify.start', function (ev, data) {\n\t\tif (ajaxify.currentPage !== data.url) {\n\t\t\tnavigator.disable();\n\n\t\t\tremoveListeners();\n\t\t}\n\t});\n\n\tfunction removeListeners() {\n\t\tsocket.removeListener('event:new_topic', Category.onNewTopic);\n\t\tcategoryTools.removeListeners();\n\t}\n\n\tCategory.init = function () {\n\t\tvar\tcid = ajaxify.data.cid;\n\n\t\tapp.enterRoom('category_' + cid);\n\n\t\tshare.addShareHandlers(ajaxify.data.name);\n\n\t\tsocket.removeListener('event:new_topic', Category.onNewTopic);\n\t\tsocket.on('event:new_topic', Category.onNewTopic);\n\n\t\tcategoryTools.init(cid);\n\n\t\tsort.handleSort('categoryTopicSort', 'user.setCategorySort', 'category/' + ajaxify.data.slug);\n\n\t\tenableInfiniteLoadingOrPagination();\n\n\t\t$('[component=\"category\"]').on('click', '[component=\"topic/header\"]', function () {\n\t\t\tvar clickedIndex = $(this).parents('[data-index]').attr('data-index');\n\t\t\t$('[component=\"category/topic\"]').each(function (index, el) {\n\t\t\t\tif ($(el).offset().top - $(window).scrollTop() > 0) {\n\t\t\t\t\tstorage.setItem('category:' + cid + ':bookmark', $(el).attr('data-index'));\n\t\t\t\t\tstorage.setItem('category:' + cid + ':bookmark:clicked', clickedIndex);\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\thandleScrollToTopicIndex();\n\n\t\thandleIgnoreWatch(cid);\n\n\t\t$(window).trigger('action:topics.loaded', { topics: ajaxify.data.topics });\n\t\t$(window).trigger('action:category.loaded', { cid: ajaxify.data.cid });\n\t};\n\n\tfunction handleScrollToTopicIndex() {\n\t\tvar parts = window.location.pathname.split('/');\n\t\tvar topicIndex = parts[parts.length - 1];\n\t\tif (topicIndex && utils.isNumber(topicIndex)) {\n\t\t\ttopicIndex = Math.max(0, parseInt(topicIndex, 10) - 1);\n\t\t\tif (topicIndex && window.location.search.indexOf('page=') === -1) {\n\t\t\t\tnavigator.scrollToElement($('[component=\"category/topic\"][data-index=\"' + topicIndex + '\"]'), true, 0);\n\t\t\t}\n\t\t}\n\t}\n\n\tfunction handleIgnoreWatch(cid) {\n\t\t$('[component=\"category/watching\"], [component=\"category/ignoring\"]').on('click', function () {\n\t\t\tvar $this = $(this);\n\t\t\tvar command = $this.attr('component') === 'category/watching' ? 'watch' : 'ignore';\n\n\t\t\tsocket.emit('categories.' + command, cid, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\t$('[component=\"category/watching/menu\"]').toggleClass('hidden', command !== 'watch');\n\t\t\t\t$('[component=\"category/watching/check\"]').toggleClass('fa-check', command === 'watch');\n\n\t\t\t\t$('[component=\"category/ignoring/menu\"]').toggleClass('hidden', command !== 'ignore');\n\t\t\t\t$('[component=\"category/ignoring/check\"]').toggleClass('fa-check', command === 'ignore');\n\n\t\t\t\tapp.alertSuccess('[[category:' + command + '.message]]');\n\t\t\t});\n\t\t});\n\t}\n\n\tCategory.toTop = function () {\n\t\tnavigator.scrollTop(0);\n\t};\n\n\tCategory.toBottom = function () {\n\t\tsocket.emit('categories.getTopicCount', ajaxify.data.cid, function (err, count) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tnavigator.scrollBottom(count - 1);\n\t\t});\n\t};\n\n\tCategory.navigatorCallback = function (topIndex, bottomIndex) {\n\t\treturn bottomIndex;\n\t};\n\n\t$(window).on('action:ajaxify.contentLoaded', function () {\n\t\tif (ajaxify.data.template.category && ajaxify.data.cid) {\n\t\t\tvar bookmarkIndex = storage.getItem('category:' + ajaxify.data.cid + ':bookmark');\n\t\t\tvar clickedIndex = storage.getItem('category:' + ajaxify.data.cid + ':bookmark:clicked');\n\n\t\t\tbookmarkIndex = Math.max(0, parseInt(bookmarkIndex, 10) || 0);\n\t\t\tclickedIndex = Math.max(0, parseInt(clickedIndex, 10) || 0);\n\t\t\tif (!parseInt(bookmarkIndex, 10)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (config.usePagination) {\n\t\t\t\tvar page = Math.ceil((parseInt(bookmarkIndex, 10) + 1) / config.topicsPerPage);\n\t\t\t\tif (parseInt(page, 10) !== ajaxify.data.pagination.currentPage) {\n\t\t\t\t\tpagination.loadPage(page, function () {\n\t\t\t\t\t\tCategory.scrollToTopic(bookmarkIndex, clickedIndex, 400);\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tCategory.scrollToTopic(bookmarkIndex, clickedIndex, 400);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (bookmarkIndex === 0) {\n\t\t\t\t\tCategory.highlightTopic(clickedIndex);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t$('[component=\"category\"]').empty();\n\n\t\t\t\tloadTopicsAfter(Math.max(0, bookmarkIndex - 1) + 1, 1, function () {\n\t\t\t\t\t$(window).one('action:topics.loaded', function () {\n\t\t\t\t\t\tCategory.scrollToTopic(bookmarkIndex, clickedIndex, 0);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t});\n\n\tCategory.highlightTopic = function (topicIndex) {\n\t\tvar highlight = components.get('category/topic', 'index', topicIndex);\n\n\t\tif (highlight.length && !highlight.hasClass('highlight')) {\n\t\t\thighlight.addClass('highlight');\n\t\t\tsetTimeout(function () {\n\t\t\t\thighlight.removeClass('highlight');\n\t\t\t}, 5000);\n\t\t}\n\t};\n\n\tCategory.scrollToTopic = function (bookmarkIndex, clickedIndex, duration, offset) {\n\t\tif (!bookmarkIndex) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!offset) {\n\t\t\toffset = 0;\n\t\t}\n\n\t\tvar scrollTo = components.get('category/topic', 'index', bookmarkIndex);\n\n\t\tif (scrollTo.length) {\n\t\t\t$('html, body').animate({\n\t\t\t\tscrollTop: (scrollTo.offset().top - offset) + 'px',\n\t\t\t}, duration !== undefined ? duration : 400, function () {\n\t\t\t\tCategory.highlightTopic(clickedIndex);\n\t\t\t\tnavigator.update();\n\t\t\t});\n\t\t}\n\t};\n\n\tfunction enableInfiniteLoadingOrPagination() {\n\t\tif (!config.usePagination) {\n\t\t\tnavigator.init('[component=\"category/topic\"]', ajaxify.data.topic_count, Category.toTop, Category.toBottom, Category.navigatorCallback);\n\t\t\tinfinitescroll.init($('[component=\"category\"]'), Category.loadMoreTopics);\n\t\t} else {\n\t\t\tnavigator.disable();\n\t\t}\n\t}\n\n\tCategory.onNewTopic = function (topic) {\n\t\tvar\tcid = ajaxify.data.cid;\n\t\tif (!topic || parseInt(topic.cid, 10) !== parseInt(cid, 10)) {\n\t\t\treturn;\n\t\t}\n\n\t\t$(window).trigger('filter:categories.new_topic', topic);\n\n\t\tvar editable = !!$('.thread-tools').length;\n\n\t\ttemplates.parse('category', 'topics', {\n\t\t\tprivileges: { editable: editable },\n\t\t\tshowSelect: editable,\n\t\t\ttopics: [topic],\n\t\t\ttemplate: { category: true },\n\t\t}, function (html) {\n\t\t\ttranslator.translate(html, function (translatedHTML) {\n\t\t\t\tvar topic = $(translatedHTML);\n\t\t\t\tvar container = $('[component=\"category\"]');\n\t\t\t\tvar topics = $('[component=\"category/topic\"]');\n\t\t\t\tvar numTopics = topics.length;\n\n\t\t\t\t$('[component=\"category\"]').removeClass('hidden');\n\t\t\t\t$('.category-sidebar').removeClass('hidden');\n\n\t\t\t\tvar noTopicsWarning = $('#category-no-topics');\n\t\t\t\tif (noTopicsWarning.length) {\n\t\t\t\t\tnoTopicsWarning.remove();\n\t\t\t\t\tajaxify.widgets.render('category', window.location.pathname.slice(1));\n\t\t\t\t}\n\n\t\t\t\tif (numTopics > 0) {\n\t\t\t\t\tfor (var x = 0; x < numTopics; x += 1) {\n\t\t\t\t\t\tvar pinned = $(topics[x]).hasClass('pinned');\n\t\t\t\t\t\tif (!pinned) {\n\t\t\t\t\t\t\ttopic.insertBefore(topics[x]);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (x === numTopics - 1) {\n\t\t\t\t\t\t\ttopic.insertAfter(topics[x]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tcontainer.append(topic);\n\t\t\t\t}\n\n\t\t\t\ttopic.hide().fadeIn('slow');\n\n\t\t\t\ttopic.find('.timeago').timeago();\n\t\t\t\tapp.createUserTooltips();\n\t\t\t\tupdateTopicCount();\n\n\t\t\t\t$(window).trigger('action:categories.new_topic.loaded');\n\t\t\t});\n\t\t});\n\t};\n\n\tfunction updateTopicCount() {\n\t\tsocket.emit('categories.getTopicCount', ajaxify.data.cid, function (err, topicCount) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\t\t\tnavigator.setCount(topicCount);\n\t\t});\n\t}\n\n\tCategory.loadMoreTopics = function (direction) {\n\t\tif (!$('[component=\"category\"]').length || !$('[component=\"category\"]').children().length) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar topics = $('[component=\"category/topic\"]');\n\t\tvar afterEl = direction > 0 ? topics.last() : topics.first();\n\t\tvar after = (parseInt(afterEl.attr('data-index'), 10) || 0) + 1;\n\n\t\tloadTopicsAfter(after, direction);\n\t};\n\n\tfunction loadTopicsAfter(after, direction, callback) {\n\t\tcallback = callback || function () {};\n\t\tif (!utils.isNumber(after) || (after === 0 && components.get('category/topic', 'index', 0).length)) {\n\t\t\treturn callback();\n\t\t}\n\n\t\t$(window).trigger('action:category.loading');\n\t\tvar params = utils.params();\n\t\tinfinitescroll.loadMore('categories.loadMore', {\n\t\t\tcid: ajaxify.data.cid,\n\t\t\tafter: after,\n\t\t\tdirection: direction,\n\t\t\tauthor: params.author,\n\t\t\ttag: params.tag,\n\t\t\tcategoryTopicSort: config.categoryTopicSort,\n\t\t}, function (data, done) {\n\t\t\tif (data.topics && data.topics.length) {\n\t\t\t\tCategory.onTopicsLoaded(data, direction, done);\n\t\t\t} else {\n\t\t\t\tdone();\n\t\t\t}\n\n\t\t\t$(window).trigger('action:category.loaded');\n\t\t\tcallback();\n\t\t});\n\t}\n\n\n\tCategory.onTopicsLoaded = function (data, direction, callback) {\n\t\tif (!data || !data.topics.length) {\n\t\t\treturn callback();\n\t\t}\n\n\t\tfunction removeAlreadyAddedTopics(topics) {\n\t\t\treturn topics.filter(function (topic) {\n\t\t\t\treturn components.get('category/topic', 'tid', topic.tid).length === 0;\n\t\t\t});\n\t\t}\n\n\t\tdata.topics = removeAlreadyAddedTopics(data.topics);\n\t\tif (!data.topics.length) {\n\t\t\treturn callback();\n\t\t}\n\n\t\tdata.showSelect = data.privileges.editable;\n\n\t\tvar after;\n\t\tvar before;\n\t\tvar topics = $('[component=\"category/topic\"]');\n\n\t\tif (direction > 0 && topics.length) {\n\t\t\tafter = topics.last();\n\t\t} else if (direction < 0 && topics.length) {\n\t\t\tbefore = topics.first();\n\t\t}\n\n\t\tapp.parseAndTranslate('category', 'topics', data, function (html) {\n\t\t\t$('[component=\"category\"]').removeClass('hidden');\n\t\t\t$('.category-sidebar').removeClass('hidden');\n\n\t\t\t$('#category-no-topics').remove();\n\n\t\t\tif (after) {\n\t\t\t\thtml.insertAfter(after);\n\t\t\t} else if (before) {\n\t\t\t\tvar height = $(document).height();\n\t\t\t\tvar scrollTop = $(window).scrollTop();\n\n\t\t\t\thtml.insertBefore(before);\n\n\t\t\t\t$(window).scrollTop(scrollTop + ($(document).height() - height));\n\t\t\t} else {\n\t\t\t\t$('[component=\"category\"]').append(html);\n\t\t\t}\n\n\t\t\tif (!topicSelect.getSelectedTids().length) {\n\t\t\t\tinfinitescroll.removeExtra($('[component=\"category/topic\"]'), direction, config.topicsPerPage * 3);\n\t\t\t}\n\n\t\t\thtml.find('.timeago').timeago();\n\t\t\tapp.createUserTooltips();\n\t\t\tutils.makeNumbersHumanReadable(html.find('.human-readable-number'));\n\n\t\t\t$(window).trigger('action:topics.loaded', { topics: data.topics });\n\n\t\t\tcallback();\n\t\t});\n\t};\n\n\treturn Category;\n});\n"]}