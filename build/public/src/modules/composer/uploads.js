"use strict";define("composer/uploads",["composer/preview","translator"],function(e,t){var i={inProgress:{}};var r;var n="uploading 0%";i.getCid=function(){return r};i.initialize=function(e,i){r=i;u(e);f(e);a(e);o(e);t.translate("[[modules:composer.uploading, "+0+"%]]",function(e){n=e})};function a(e){var t=$("#cmp-uuid-"+e);t.find("#files").on("change",function(t){var i=(t.target||{}).files||($(this).val()?[{name:$(this).val(),type:utils.fileMimeType($(this).val())}]:null);if(i){p({files:i,post_uuid:e,route:"/api/post/upload"})}});t.find("#topic-thumb-file").on("change",function(t){var i=(t.target||{}).files||($(this).val()?[{name:$(this).val(),type:utils.fileMimeType($(this).val())}]:null),r;if(i){if(window.FormData){r=new FormData;for(var n=0;n<i.length;++n){r.append("files[]",i[n],i[n].name)}}d({files:i,post_uuid:e,route:"/api/topic/thumb/upload",formData:r})}})}function o(e){var t=$("#cmp-uuid-"+e);t.on("click",".topic-thumb-clear-btn",function(e){t.find("input#topic-thumb-url").val("").trigger("change");s(t.find("input#topic-thumb-file"));$(this).addClass("hide");e.preventDefault()});t.on("paste change keypress","input#topic-thumb-url",function(){var e=$(this);setTimeout(function(){var i=e.val();if(i){t.find(".topic-thumb-clear-btn").removeClass("hide")}else{s(t.find("input#topic-thumb-file"));t.find(".topic-thumb-clear-btn").addClass("hide")}t.find("img.topic-thumb-preview").attr("src",i)},100)})}i.toggleThumbEls=function(e,t){var i=e.find(".topic-thumb-toggle-btn");e.find("input#topic-thumb-url").val(t);e.find("img.topic-thumb-preview").attr("src",t);if(t){e.find(".topic-thumb-clear-btn").removeClass("hide")}i.removeClass("hide");i.off("click").on("click",function(){var t=e.find(".topic-thumb-container");t.toggleClass("hide",!t.hasClass("hide"))})};function s(e){e.wrap("<form />").closest("form").get(0).reset();e.unwrap()}function u(e){function t(){if(n){return}o.css("top","0px");o.css("height",a.height()+"px");o.css("line-height",a.height()+"px");o.show();o.on("dragleave",function(){o.hide();o.off("dragleave")})}function i(t){t.preventDefault();var i=t.originalEvent.dataTransfer.files;var r;if(i.length){if(window.FormData){r=new FormData;for(var n=0;n<i.length;++n){r.append("files[]",i[n],i[n].name)}}p({files:i,post_uuid:e,route:"/api/post/upload",formData:r})}o.hide();return false}function r(e){e.preventDefault();return false}var n=false;var a=$("#cmp-uuid-"+e);var o=a.find(".imagedrop");$(document).off("dragstart").on("dragstart",function(){n=true}).off("dragend").on("dragend",function(){n=false});a.on("dragenter",t);o.on("dragover",r);o.on("dragenter",r);o.on("drop",i)}function f(e){$(window).off("paste").on("paste",function(t){var i=(t.clipboardData||t.originalEvent.clipboardData||{}).items;[].some.call(i,function(t){var i=t.getAsFile();if(!i){return false}var r=utils.generateUUID()+"-"+i.name;var n=null;if(window.FormData){n=new FormData;n.append("files[]",i,r)}p({files:[i],fileNames:[r],post_uuid:e,route:"/api/post/upload",formData:n});return true})})}function l(e){return e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}function c(e,t,i){return e.slice(0,t)+i+e.slice(t)}function p(a){var o=a.files;var s=a.post_uuid;var u=$("#cmp-uuid-"+s);var f=u.find("textarea");var p=f.val();var d=u.find("#fileForm");d.attr("action",config.relative_path+a.route);var g=u.find(".category-list");r=g.length?g.val():r;var h=[];for(var v=0;v<o.length;++v){h.push(v+"_"+Date.now()+"_"+(a.fileNames?a.fileNames[v]:o[v].name));var b=o[v].type.match(/image./);if(o[v].size>parseInt(config.maximumFileSize,10)*1024){d[0].reset();return app.alertError("[[error:file-too-big, "+config.maximumFileSize+"]]")}p=c(p,f.getCursorPosition(),(b?"!":"")+"["+h[v]+"]("+n+") ")}f.val(p);d.off("submit").submit(function(){function n(e,t){var i=f.val();var r=new RegExp(l(e)+"]\\([^)]+\\)","g");f.val(i.replace(r,e+"]("+t+")"))}i.inProgress[s]=i.inProgress[s]||[];i.inProgress[s].push(1);if(a.formData){a.formData.append("cid",r)}$(this).ajaxSubmit({headers:{"x-csrf-token":config.csrf_token},resetForm:true,clearForm:true,formData:a.formData,data:{cid:r},error:m,uploadProgress:function(e,i,r,a){t.translate("[[modules:composer.uploading, "+a+"%]]",function(e){for(var t=0;t<o.length;++t){n(h[t],e)}})},success:function(t){if(t&&t.length){for(var i=0;i<t.length;++i){n(h[i],t[i].url)}}e.render(u);f.focus()},complete:function(){d[0].reset();i.inProgress[s].pop()}});return false});d.submit()}function d(e){var t=e.post_uuid,r=$("#cmp-uuid-"+t),n=r.find(".topic-thumb-spinner"),a=r.find("#thumbForm");a.attr("action",config.relative_path+e.route);a.off("submit").submit(function(){n.removeClass("hide");i.inProgress[t]=i.inProgress[t]||[];i.inProgress[t].push(1);$(this).ajaxSubmit({headers:{"x-csrf-token":config.csrf_token},formData:e.formData,error:m,success:function(e){r.find("#topic-thumb-url").val((e[0]||{}).url||"").trigger("change")},complete:function(){i.inProgress[t].pop();n.addClass("hide")}});return false});a.submit()}function m(e){var t=e.responseJSON&&e.responseJSON.error||"[[error:parse-error]]";app.alertError(t)}return i});
//# sourceMappingURL=node_modules/nodebb-plugin-composer-default/static/lib/composer/uploads.js.map